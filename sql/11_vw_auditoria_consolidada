-- Objetivo: Generar KPIs finales para el cierre de mes de NutriData-AR.
-- Valor de negocio: Provee mÃ©tricas de salud pÃºblica listas para dashboards.

SELECT 
    -- 1. Â¿QuÃ© porcentaje del mercado es crÃ­tico?
    ROUND(COUNTIF(nivel_riesgo = 'ðŸ”´ ALTO') * 100.0 / COUNT(*), 2) as pct_alto_riesgo,
    
    -- 2. Â¿CuÃ¡ntos productos exceden los lÃ­mites de la OMS?
    COUNTIF(cumplimiento_oms = 'EXCEDE') as total_excedidos_oms,
    
    -- 3. Â¿CuÃ¡l es el promedio de azÃºcar en los productos que CUMPLEN?
    ROUND(AVG(azucares_100g) FILTER (WHERE cumplimiento_oms = 'CUMPLE'), 2) as promedio_azucar_saludable
    
FROM `nutricion-ar.datos_nutricionales.vw_auditoria_consolidada`;
